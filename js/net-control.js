define(function(require,exports,module){function getBlackLength(){var $td,index=0,i=0,$listTable=$("#qosList").children(),length=$listTable.length,$blackTable=$("#qosListAccess").children(),blackLength=$blackTable.length;if(1==length&&$listTable.eq(0).children().length<2);else for(i=0;length>i;i++)$td=$listTable.eq(i).children(),($td.eq(5).children().hasClass("icon-toggle-off")||"0"==$td.eq(4).find(".input-append")[0].val()||0==$td.eq(3).find(".input-append")[0].val())&&index++;if(1==blackLength&&$blackTable.eq(0).children().length<2);else for(i=0;blackLength>i;i++)"none"!=$blackTable.eq(i).css("display")&&index++;return index}function AttachedModule(){function createOnlineList(arry){var prop,i=0,len=arry.length,str="",selectDownObj={initVal:"21",editable:"1",size:"small",seeAsTrans:!0,options:[{"No Limit":_("No Limit")},{128:_("1.0Mbps(Web Browsing)")},{256:_("2.0Mbps(SD Videos)")},{512:_("3.0Mbps(HD Videos)")},{".divider":".divider"},{".hand-set":_("Manual(unit: Mbps)")}]},selectUpObj={initVal:"21",editable:"1",size:"small",seeAsTrans:!0,options:[{"No Limit":_("No Limit")},{32:_("0.25Mbps")},{64:_("0.50Mbps")},{128:_("1.0Mbps")},{".divider":".divider"},{".hand-set":_("Manual(unit: Mbps)")}]};arry=reCreateObj(arry,"qosListIP","up");var upLimit,downLimit,hostname,connectType,ipStr,localhostIP=pageModule.data.localhost||"";for(i=0;len>i;i++)if(arry[i].qosListAccess&&"true"==arry[i].qosListAccess){str="<tr class='addListTag'>";for(prop in arry[i])hostname=""!=arry[i].qosListRemark?arry[i].qosListRemark:arry[i].qosListHostname,connectType="wifi"==arry[i].qosListConnectType?"icon-wireless":"icon-wired",ipStr=localhostIP==arry[i].qosListIP?arry[i].qosListIP+_("(Native Device)"):arry[i].qosListIP,"qosListHostname"==prop?(str+="<td>",str+='<div class="col-xs-10 span-fixed deviceName"></div>',str+='<div class="col-xs-10 none">',str+=' <input type="text" class="form-control setDeviceName" value="" maxLength="20">',str+="</div>",str+='<div class="col-xs-2 row"> <span class="ico-small icon-edit"></span> </div>',str+='<div class="col-xs-12 help-inline"> <span class="ico-small '+connectType+'"></span> <span>'+ipStr+"</span> </div>",str+="</td>"):"qosListUpSpeed"==prop||"qosListDownSpeed"==prop?(str+='<td class="span-fixed" style="width:10%;">',str+="qosListUpSpeed"==prop?'<span class="text-warning">&uarr;</span> <span>'+shapingSpeed(arry[i][prop])+"</span>":'<span class="text-success">&darr;</span> <span>'+shapingSpeed(arry[i][prop])+"</span>",str+="</td>"):"qosListUpLimit"==prop||"qosListDownLimit"==prop?(str+="<td>",str+='<span class="dropdown '+prop+' input-medium validatebox" required="required" maxLength="5"></span>',str+="</td>","qosListUpLimit"==prop?(upLimit=arry[i][prop]+"KB/s",+arry[i][prop]>=38401&&(upLimit="No Limit")):(downLimit=arry[i][prop]+"KB/s",+arry[i][prop]>=38401&&(downLimit="No Limit"))):"qosListAccess"==prop&&(str+="<td>",str+="<div class='switch icon-toggle-on'></div>",str+="</td>");str+="</tr>",$("#qosList").append(str),$("#qosList .addListTag").find(".deviceName").text(hostname),$("#qosList .addListTag").find(".deviceName").attr("title",hostname),$("#qosList .addListTag").find(".setDeviceName").val(hostname),$("#qosList .addListTag").find(".setDeviceName").attr("data-mark",arry[i].qosListHostname),$("#qosList .addListTag").find(".setDeviceName").attr("alt",arry[i].qosListMac.toUpperCase()),selectUpObj.initVal=upLimit,$("#qosList .addListTag").find(".qosListUpLimit").toSelect(selectUpObj),"No Limit"==upLimit&&$("#qosList .addListTag").find(".qosListUpLimit").find("input[type='text']").val(_("No Limit")),selectDownObj.initVal=downLimit,$("#qosList .addListTag").find(".qosListDownLimit").toSelect(selectDownObj),"No Limit"==downLimit&&$("#qosList .addListTag").find(".qosListDownLimit").find("input[type='text']").val(_("No Limit")),$("#qosList .addListTag").find(".input-box").attr("maxLength","5"),$("#qosList").find(".addListTag").children().eq(1).addClass("hidden-max-sm"),$("#qosList").find(".addListTag").children().eq(2).addClass("hidden-max-md"),$("#qosList").find(".addListTag").children().eq(3).addClass("hidden-max-xs"),$("#qosList").find(".addListTag").children().eq(4).addClass("hidden-max-md"),$("#qosList").find(".addListTag").removeClass("addListTag")}else str="<tr class='addListTag'>",str+="<td class='deviceName'><div class='col-xs-11 span-fixed'>",str+="</div></td>",str+="<td class='hidden-max-xs'>"+arry[i].qosListMac.toUpperCase()+"</td>",str+="<td>",str+='<input type="button" class="del btn" value="'+_("Remove")+'">',str+="</td>",str+="</tr>",$("#qosListAccess").append(str),hostname=""!=arry[i].qosListRemark?arry[i].qosListRemark:arry[i].qosListHostname,$("#qosListAccess .addListTag").find(".deviceName div").text(hostname),$("#qosListAccess .addListTag").find(".deviceName").attr("data-mark",arry[i].qosListHostname),$("#qosListAccess").find(".addListTag").removeClass("addListTag");$("#qosDeviceCount").html("("+$("#qosList").children().length+")"),0==$("#qosList").children().length&&(str="<tr><td colspan='2'>"+_("No device")+"</td></tr>",$("#qosList").append(str)),$("#blockedDeviceCount").html("("+$("#qosListAccess").children().length+")"),0==$("#qosListAccess").children().length&&(str="<tr><td colspan='2'>"+_("No device")+"</td></tr>",$("#qosListAccess").append(str)),top.mainLogic.initModuleHeight()}function shapingSpeed(value){var val=parseFloat(value);return val>1024?(val/1024).toFixed(2)+"MB/s":val.toFixed(0)+"KB/s"}function refreshTableList(){return $.getJSON("goform/getQos"+getRandom(),updateTable),!refreshDataFlag||dataChanged?void clearTimeout(timeFlag):(clearTimeout(timeFlag),timeFlag=setTimeout(function(){refreshTableList()},5e3),void(pageModule.pageRunning||clearTimeout(timeFlag)))}function updateTable(obj){if(isEmptyObject(obj))return void top.location.reload(!0);var newMac,listData=obj.qosList,newLength=listData.length,i=0;if(pageModule.pageRunning&&!dataChanged){var oldMac,$tbodyList=$("#qosList").children(),oldLength=$tbodyList.length,j=0,rowData=new Array(oldLength),refreshObj=new Array(newLength),newData=[];for(i=0;newLength>i;i++)for(newMac=listData[i].qosListMac.toUpperCase(),refreshObj[i]={},j=0;oldLength>j;j++){var $input=$tbodyList.eq(j).children().eq(0).find("input");oldMac=$input[0]?$input.eq(0).attr("alt").toUpperCase():"",oldMac==newMac&&(rowData[j]={},$tbodyList.eq(j).children().eq(5).children().hasClass("icon-toggle-on")&&($tbodyList.eq(j).children().eq(2).find("span").eq(1).html(shapingSpeed(listData[i].qosListUpSpeed)),$tbodyList.eq(j).children().eq(1).find("span").eq(1).html(shapingSpeed(listData[i].qosListDownSpeed))),rowData[j].refresh=!0,refreshObj[i].exist=!0),$tbodyList.eq(i).children().eq(0).find("input").eq(0).hasClass("edit-old")&&(rowData[j]={},rowData[j].refresh=!0)}for(i=0;newLength>i;i++)refreshObj[i].exist||newData.push(listData[i]);for(j=0;oldLength>j;j++)rowData[j]&&rowData[j].refresh||$tbodyList.eq(j).remove();$("#qosListAccess").html(""),createOnlineList(newData)}}function editDeviceName(){var deviceName=$(this).parent().prev().prev().text(),reMarkMaxLength="";$(this).parent().prev().prev().hide(),$(this).parent().hide(),$(this).parent().prev().show(),$(this).parent().prev().find("input").addClass("edit-old"),reMarkMaxLength=$(this).parent().prev().find("input").attr("maxLength"),$(this).parent().prev().find("input").val(deviceName.substring(0,reMarkMaxLength)),$(this).parent().prev().find("input").focus()}function clickAccessInternet(){var className=this.className;if("switch icon-toggle-on"==className){if(getBlackLength()>=10)return void top.mainLogic.showModuleMsg(_("Up to %s devices can be added to blacklist.",[10]));this.className="switch icon-toggle-off"}else this.className="switch icon-toggle-on"}function getAttacheList(){var $td,upLimit,downLimit,internetAccess,str="",$listTable=$("#qosList").children(),length=$listTable.length,i=0;if(1==length&&$listTable.eq(0).children().length<2)return"";for(i=0;length>i;i++)$td=$listTable.eq(i).children(),internetAccess=$td.eq(5).children().hasClass("icon-toggle-on"),str+=$td.find("input").eq(0).attr("data-mark")+"	",str+=$td.find("input").eq(0).val()==$td.find("input").eq(0).attr("data-mark")?"	":$td.find("input").eq(0).val()+"	",str+=$td.find("input").eq(0).attr("alt")+"	",upLimit=internetAccess?"No Limit"==$td.eq(4).find(".input-append")[0].val()?"38528":parseInt($td.eq(4).find(".input-append")[0].val(),10):"0",+upLimit>=38528&&(upLimit=38528),str+=upLimit+"	",downLimit=internetAccess?"No Limit"==$td.eq(3).find(".input-append")[0].val()?"38528":parseInt($td.eq(3).find(".input-append")[0].val(),10):"0",+downLimit>=38528&&(downLimit=38528),str+=downLimit+"	",str+=$td.eq(5).children().hasClass("icon-toggle-on")+"\n";return str=str.replace(/[\n]$/,"")}function getBlockedList(){var hostname,permitStr="",forbidStr="",data={},$listTable=$("#qosListAccess").children(),length=$listTable.length,i=0;if(1==length&&$listTable.eq(0).children().length<2)return data={permit:"",forbid:""};for(i=0;length>i;i++)"none"==$listTable.eq(i).css("display")?(hostname=$listTable.eq(i).children().eq(0).attr("data-mark"),permitStr+=hostname+"	",permitStr+=hostname==$listTable.eq(i).children().eq(0).text()?"	":$listTable.eq(i).children().eq(0).text()+"	",permitStr+=$listTable.eq(i).children().eq(1).text()+"	",permitStr+="38528	",permitStr+="38528	",permitStr+="true\n"):(hostname=$listTable.eq(i).children().eq(0).attr("data-mark"),forbidStr+=hostname+"	",forbidStr+=hostname==$listTable.eq(i).children().eq(0).text()?"	":$listTable.eq(i).children().eq(0).text()+"	",forbidStr+=$listTable.eq(i).children().eq(1).text()+"	",forbidStr+="0	",forbidStr+="0	",forbidStr+="false\n");return data={permit:permitStr.replace(/[\n]$/,""),forbid:forbidStr.replace(/[\n]$/,"")}}var timeFlag,refreshDataFlag=!0,dataChanged=!1;this.init=function(){this.initEvent()},this.initEvent=function(){$("#qosList").delegate(".icon-edit","click",editDeviceName),$("#qosList").delegate(".icon-toggle-on, .icon-toggle-off","click",clickAccessInternet),$("#qosList").delegate(".edit-old","blur",function(){$(this).parent().prev().attr("title",$(this).val()),$(this).parent().prev().text($(this).val()),$(this).parent().hide(),$(this).parent().prev().show(),$(this).parent().next().show()}),$("#qosListAccess").delegate(".del","click.dd",function(evnet){evnet||window.event;$(this).parent().parent().css("display","none"),dataChanged=!0}),$("#qosList").delegate(".dropdown input[type='text']","blur.refresh",function(){return refreshDataFlag=!0,this.value.replace(/[ ]+$/,"")==_("No Limit")?(this.value=_("No Limit"),void $(this).next().val("No Limit")):(isNaN(parseFloat(this.value))?this.value="":(-1!==this.value.indexOf(".")&&(this.value=this.value.split(".")[0]),this.value=parseFloat(this.value).toFixed(2)>38400?_("No Limit"):parseInt(this.value,10)+"KB/s"),void(timeFlag=setTimeout(function(){refreshTableList()},5e3)))}),$("#qosList").delegate(".dropdown .input-box","focus.refresh change.refresh",function(){this.value=this.value.replace(/[KB\/s]+$/,""),refreshDataFlag=!1})},this.initValue=function(){timeFlag=setTimeout(function(){refreshTableList()},5e3),obj=pageModule.data,$("#qosList").html(""),$("#qosListAccess").html(""),createOnlineList(obj.qosList)},this.checkData=function(){var $td,upLimit,downLimit,deviceName="",$listTable=$("#qosList").children(),length=$listTable.length,i=0;if(!(1==length&&$listTable.eq(0).children().length<2))for(i=0;length>i;i++){if($td=$listTable.eq(i).children(),deviceName=$td.find("input").eq(0).val(),upLimit=$td.eq(4).find(".input-append")[0].val(),downLimit=$td.eq(3).find(".input-append")[0].val(),""==deviceName.replace(/[ ]/g,""))return $td.find("input").eq(0).focus(),_("Space is not supported in a password!");if(upLimit==_("No Limit")&&(upLimit="No Limit"),downLimit==_("No Limit")&&(downLimit="No Limit"),isNaN(parseFloat(upLimit))&&"No Limit"!=upLimit)return $td.eq(4).find(".dropdown .input-box").focus(),_("Please input a valid number.");if(isNaN(parseFloat(downLimit))&&"No Limit"!=downLimit)return $td.eq(3).find(".dropdown .input-box").focus(),_("Please input a valid number.")}},this.getSubmitData=function(){var list,data={},blockedData=getBlockedList(),attachedData=getAttacheList();return list=attachedData,blockedData.permit.length>0&&(list+="\n"+blockedData.permit),blockedData.forbid.length>0&&(list+="\n"+blockedData.forbid),data={qosList:list},objToString(data)}}var pageModule=new PageLogic("goform/getQos","goform/setQos");pageModule.modules=[],module.exports=pageModule;var netCrlModule=new AttachedModule;pageModule.modules.push(netCrlModule),pageModule.beforeSubmit=function(){return getBlackLength()>10?(top.mainLogic.showModuleMsg(_("Up to %s devices can be added to blacklist.",[10])),!1):!0}});